<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    
    {% load static %}
    <script src="{% static "cookie.js" %}"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    
    <style>
        textarea {
            overflow-y: scroll;
            resize: none;
            width: 1000px;
            height: 350px;
        }
    </style>

    <title>Let's chat!</title>
</head>
<body>
    <h1>{{ room_name }}</h1>
    <textarea readonly id="log"></textarea><br/>
    <input id="input" type="text" size="100"/><br/>
    <input id="submit" type="button" value="Send"/>
</body>
<script>
    var roomName = {{ room_name_json }};
    var messages = JSON.parse({{ messages_json }});
    var token = getCookie("csrftoken");
    var log = document.querySelector("#log")
    var input = document.querySelector("#input");
    var submit = document.querySelector("#submit");

    // Fill in previous messages
    for (var i = 0; i < messages.length; i++) {
        log.value += messages[i].fields["message"];
    }

    var chatSocket = new WebSocket(
        "ws://" + window.location.host +
        "/OB/chat/" + roomName + "/");

    chatSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var message = data["message"];
        log.value += (message + "\n");
        log.scrollTop = log.scrollHeight;
    };

    chatSocket.onclose = function(e) {
        console.error("Chat socket closed unexpectedly");
    };

    input.focus();
    input.onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            submit.click();
        }
    };

    document.querySelector("#submit").onclick = function(e) {
        var message = input.value.trim();

        if (message === "") {
            return;
        }

        chatSocket.send(JSON.stringify({
            "message": message
        }));
    };

    $(document).ready(function() {
        $("#submit").click(function(e) {
            var url = "/OB/chat/" + roomName + "/";
            $.ajax({
                headers: { "X-CSRFToken": token},
                type: "POST",
                url: url,
                data: {
                    "message": input.value.trim()
                },
            });
            input.value = "";
        });
    });
</script>
</html>